# æ–‡ä»¶è·¯å¾„: .github/workflows/daily-step-runner.yml

name: Daily Step Runner with Notification

# è§¦å‘å™¨é…ç½®
on:
  # 1. å®šæ—¶è§¦å‘ï¼šä½¿ç”¨cronè¯­æ³•
  # '30 0 * * *' ä»£è¡¨ UTC æ—¶é—´çš„ 00:30ï¼Œå³åŒ—äº¬æ—¶é—´ (UTC+8) çš„ 08:30ã€‚
  schedule:
    - cron: '46 0 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸ä½ åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  # å®šä¹‰ä¸€ä¸ªåä¸º run-and-notify çš„ä»»åŠ¡
  run-and-notify:
    # ä½¿ç”¨GitHubæä¾›çš„æœ€æ–°ç‰ˆUbuntuè™šæ‹Ÿæœºä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest

    # å®šä¹‰ä»»åŠ¡ä¸­çš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šè¿è¡Œä¸»è„šæœ¬å¹¶å‘é€é€šçŸ¥
      - name: Run Job and Send PushPlus Notification
        run: |
          # --- ç”¨æˆ·é…ç½®åŒºï¼šè®¾ç½®æ­¥æ•°èŒƒå›´ ---
          MIN_STEPS=20000
          MAX_STEPS=28000

          # --- æ ¸å¿ƒè„šæœ¬åŒº ---
          # 1. åœ¨èŒƒå›´å†…ç”Ÿæˆä¸€ä¸ªéšæœºæ­¥æ•°
          RANDOM_STEPS=$((RANDOM % (MAX_STEPS - MIN_STEPS + 1) + MIN_STEPS))
          echo "Generated random steps: $RANDOM_STEPS"

          # 2. ä½¿ç”¨ curl å‘é€åˆ·æ­¥è¯·æ±‚å¹¶æ•è·æœåŠ¡å™¨å“åº”
          # æ–°å¢: -H "Referer: ..." å’Œ -A "..." æ¥æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚å¤´
          API_URL="http://api3.jlwz.cn/bs_2021.php"
          RESPONSE=$(curl -sS --connect-timeout 15 \
            -H "Referer: https://3g.gljlw.com/" \
            -A "Mozilla/5.0 (iPhone; CPU iPhone OS 15_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.1 Mobile/15E148 Safari/604.1" \
            "${API_URL}?mobile=${{ secrets.USER_EMAIL }}&psw=${{ secrets.USER_PASSWORD }}&step=$RANDOM_STEPS&type=2")
          
          # åœ¨æ—¥å¿—ä¸­æ‰“å°æœåŠ¡å™¨çš„åŸå§‹å“åº”ï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "Server Response: $RESPONSE"

          # 3. æ ¹æ®æœåŠ¡å™¨å“åº”ç»“æœï¼Œå‡†å¤‡ä¸åŒçš„æ¨é€å†…å®¹
          # æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«æˆåŠŸçš„å…³é”®ä»£ç  "code":"1"
          if [[ "$RESPONSE" == *'"code":"1"'* ]]; then
            TITLE="âœ… åˆ·æ­¥æˆåŠŸ-$(date +'%Y-%m-%d')"
            # ä½¿ç”¨ Markdown æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œä½¿å…¶åœ¨å¾®ä¿¡ä¸Šæ›´ç¾è§‚
            CONTENT="### ğŸ‰ åˆ·æ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼\n\n- **æäº¤æ­¥æ•°**: **$RANDOM_STEPS** æ­¥\n\n- **æœåŠ¡å™¨å“åº”**: \`$RESPONSE\`\n\n- **æ‰§è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') (UTC)"
          else
            TITLE="âŒ åˆ·æ­¥å¤±è´¥-$(date +'%Y-%m-%d')"
            CONTENT="### âš ï¸ åˆ·æ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼\n\nè¯·ç™»å½• GitHub Actions æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚\n\n- **æœåŠ¡å™¨å“åº”**: \`$RESPONSE\`\n\n- **æ‰§è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') (UTC)"
          fi

          # 4. è°ƒç”¨ PushPlus API å‘é€é€šçŸ¥
          # ä½¿ç”¨ -d å‚æ•°é€šè¿‡POSTæ–¹å¼å‘é€æ•°æ®ï¼Œå¯ä»¥æ›´å¥½åœ°å¤„ç†å†…å®¹ä¸­çš„ç‰¹æ®Šå­—ç¬¦
          curl -sS --connect-timeout 15 \
            -X POST "http://www.pushplus.plus/send" \
            -d "token=${{ secrets.PUSHPLUS_TOKEN }}" \
            -d "title=$TITLE" \
            -d "content=$CONTENT" \
            -d "template=markdown"

# æ–‡ä»¶è·¯å¾„: .github/workflows/daily-step-runner.yml

name: Multi-Time Daily Step Runner

# è§¦å‘å™¨é…ç½®
on:
  # 1. è®¾ç½®å¤šä¸ªå®šæ—¶è§¦å‘å™¨ï¼Œé¿å¼€æ•´ç‚¹
  schedule:
    # ä»»åŠ¡ä¸€ï¼šåŒ—äº¬æ—¶é—´ æ—©ä¸Š 8:46 (00:46 UTC)
    - cron: '46 0 * * *'
    # ä»»åŠ¡äºŒï¼šåŒ—äº¬æ—¶é—´ ä¸‹åˆ 14:46 (06:46 UTC)
    - cron: '46 6 * * *'
  
  # 2. ä¿ç•™æ‰‹åŠ¨è§¦å‘åŠŸèƒ½ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  run-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Run Job and Send PushPlus Notification
        run: |
          # --- æ ¸å¿ƒè„šæœ¬åŒº ---
          # 1. è·å–å½“å‰çš„UTCå°æ—¶ (0-23)
          CURRENT_HOUR_UTC=$(date -u +'%H')
          echo "Current UTC hour is: $CURRENT_HOUR_UTC. This will determine the step range."

          # 2. æ ¹æ®UTCæ—¶é—´åˆ¤æ–­æ˜¯å“ªä¸ªä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„æ­¥æ•°èŒƒå›´å’Œä»»åŠ¡å
          #    æˆ‘ä»¬ç”¨ä¸€ä¸ªå®½æ¾çš„èŒƒå›´ï¼ˆ< 3ï¼‰æ¥åˆ¤æ–­æ—©é—´ä»»åŠ¡ï¼Œä»¥é˜²ä»»åŠ¡å¯åŠ¨æœ‰å»¶è¿Ÿ
          if (( CURRENT_HOUR_UTC < 3 )); then
            # è¿™æ˜¯æ—©é—´ä»»åŠ¡ (00:xx UTC)
            RUN_TYPE="æ¸…æ™¨"
            MIN_STEPS=1000
            MAX_STEPS=9999
            echo "Morning schedule detected. Step range: $MIN_STEPS - $MAX_STEPS."
          else
            # è¿™æ˜¯åˆåä»»åŠ¡ (06:xx UTC)
            RUN_TYPE="åˆå"
            MIN_STEPS=20000
            MAX_STEPS=30000
            echo "Afternoon schedule detected. Step range: $MIN_STEPS - $MAX_STEPS."
          fi
          
          # æ‰‹åŠ¨è¿è¡Œæ—¶ï¼Œä¹Ÿä¼šæ ¹æ®å½“å‰æ—¶é—´è‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªèŒƒå›´

          # 3. åœ¨é€‰å®šçš„èŒƒå›´å†…ç”Ÿæˆéšæœºæ­¥æ•°
          RANDOM_STEPS=$((RANDOM % (MAX_STEPS - MIN_STEPS + 1) + MIN_STEPS))
          echo "Final steps to submit: $RANDOM_STEPS"

          # 4. ä½¿ç”¨ curl å‘é€åˆ·æ­¥è¯·æ±‚å¹¶æ•è·æœåŠ¡å™¨å“åº”
          API_URL="http://api3.jlwz.cn/bs_2021.php"
          RESPONSE=$(curl -sS --connect-timeout 15 \
            -H "Referer: https://3g.gljlw.com/" \
            -A "Mozilla/5.0 (iPhone; CPU iPhone OS 15_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.1 Mobile/15E148 Safari/604.1" \
            "${API_URL}?mobile=${{ secrets.USER_EMAIL }}&psw=${{ secrets.USER_PASSWORD }}&step=$RANDOM_STEPS&type=2")
          
          echo "Server Response: $RESPONSE"

          # 5. æ ¹æ®æœåŠ¡å™¨å“åº”ç»“æœï¼Œå‡†å¤‡ä¸åŒçš„æ¨é€å†…å®¹
          if [[ "$RESPONSE" == *'"code":"1"'* ]]; then
            TITLE="âœ… $RUN_TYPE åˆ·æ­¥æˆåŠŸ-$(date +'%Y-%m-%d')"
            CONTENT="### ğŸ‰ $RUN_TYPE åˆ·æ­¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼\n\n- **æäº¤æ­¥æ•°**: **$RANDOM_STEPS** æ­¥\n\n- **ä»»åŠ¡èŒƒå›´**: $MIN_STEPS - $MAX_STEPS\n\n- **æœåŠ¡å™¨å“åº”**: \`$RESPONSE\`\n\n- **æ‰§è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') (UTC)"
          else
            TITLE="âŒ $RUN_TYPE åˆ·æ­¥å¤±è´¥-$(date +'%Y-%m-%d')"
            CONTENT="### âš ï¸ $RUN_TYPE åˆ·æ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼\n\nè¯·ç™»å½• GitHub Actions æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚\n\n- **å°è¯•æ­¥æ•°**: $RANDOM_STEPS\n\n- **æœåŠ¡å™¨å“åº”**: \`$RESPONSE\`\n\n- **æ‰§è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') (UTC)"
          fi

          # 6. è°ƒç”¨ PushPlus API å‘é€é€šçŸ¥
          curl -sS --connect-timeout 15 \
            -X POST "http://www.pushplus.plus/send" \
            -d "token=${{ secrets.PUSHPLUS_TOKEN }}" \
            -d "title=$TITLE" \
            -d "content=$CONTENT" \
            -d "template=markdown"
